---
title: N + 1 ë¬¸ì œì™€ í•´ê²°ë°©ë²• ğŸ§Šï¸
summary: 
date: 2024-05-31 22:13:11 +0900
lastmod: 2024-05-31 22:13:11 +0900
tags: 
categories: 
description: 
showToc: true
tocOpen: true
---

 
## Post ì—”í‹°í‹°

```java
@Entity
public class Post {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    private String title;
    private String content;

    @OneToMany(mappedBy = "post", fetch = FetchType.LAZY, cascade = CascadeType.ALL)
    private List<Comment> comments = new ArrayList<>();
}
```


## Comment ì—”í‹°í‹°

```java
@Entity
public class Comment {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    private String content;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "post_id")
    private Post post;
}
```

ì¼ë°˜ì ìœ¼ë¡œ ì´ë ‡ê²Œ ì‘ì„±í•˜ì…¨ìœ¼ë©´, ì‹¤ì œ ë°ì´í„°ë² ì´ìŠ¤ì—ëŠ” ì•„ë˜ì²˜ëŸ¼ í…Œì´ë¸”ì´ ìƒì„±ë©ë‹ˆë‹¤.

## Post í…Œì´ë¸”

| ì»¬ëŸ¼ ì´ë¦„ | ë°ì´í„° íƒ€ì… | ì œì•½ ì¡°ê±´                          |
|-----------|-------------|-------------------------------------|
| id        | BIGINT      | PRIMARY KEY, AUTO_INCREMENT        |
| title     | VARCHAR(255)| NOT NULL                           |
| content   | TEXT        |                                     |

## Comment í…Œì´ë¸”

| ì»¬ëŸ¼ ì´ë¦„ | ë°ì´í„° íƒ€ì… | ì œì•½ ì¡°ê±´                          |
|-----------|-------------|-------------------------------------|
| id        | BIGINT      | PRIMARY KEY, AUTO_INCREMENT        |
| content   | TEXT        |                                    |
| post_id   | BIGINT      | FOREIGN KEY, NOT NULL              |
|           |             |                                    |

## ì—°ê´€ê´€ê³„ì˜ ì£¼ì¸

ì—°ê´€ê´€ê³„ ì£¼ì¸ì„ ì„¤ì •í•œë‹¤ëŠ”ê±´ ì™¸ë˜í‚¤ë¥¼ ì–´ë””ì— ë‘ëŠ”ì§€ ì„¤ì •í•˜ëŠ”ê±°ê³ . mappedByë¥¼ ì„¤ì •í•œë‹¤ëŠ”ê±´ ì™¸ë˜í‚¤ë¥¼ ê°€ì§€ê³  ìˆëŠ” ìª½ì´ ì•„ë‹ˆë¼, ë°˜ëŒ€ìª½(ì½”ë©˜íŠ¸ìª½!)ì— ìˆëŠ” ì—”í‹°í‹°ê°€ ì£¼ì¸ì´ë¼ëŠ” ê²ƒì…ë‹ˆë‹¤.
DBê´€ì ì—ì„œ ìƒê°í•´ë³´ë©´, 

`post_idê°€ 3ë²ˆì¸ ì½”ë©˜íŠ¸ë¥¼ ì°¾ì•„ë¼!` ì™€ ê°™ì´ ì§ˆë¬¸í•˜ëŠ” ìƒí™©ì´ ë§ê² ì£ ? (ì—¬ê¸°ë¥¼ ê°€ì¥ í—·ê°ˆë ¤í•˜ì‹œëŠ” ê²ƒ ê°™ì•„ìš”)

ì˜ˆë¥¼ë“¤ì–´ ë§Œì•½ ê·¸ëŸ´ì¼ ì—†ê² ì§€ë§Œ, Postì— Commentì˜ ì™¸ë˜í‚¤ë¥¼ ì¼ëŒ€ë‹¤ë¡œ ê°€ì§€ê³  ì‹¶ë‹¤ë©´, ì™¸ë˜í‚¤ì˜ ë°°ì—´ì„ ê°€ì§€ê³  ìˆì–´ì•¼ í•˜ëŠ” ê²ë‹ˆë‹¤.

1ë²ˆ í¬ìŠ¤íŠ¸ì— `[3ë²ˆì½”ë©˜íŠ¸, 4ë²ˆì½”ë©˜íŠ¸, 5ë²ˆ ì½”ë©˜íŠ¸]` ì´ëŸ°ì‹ìœ¼ë¡œìš”.

ì´ëŸ¬í•œ ê²½ìš° postë¥¼ ì˜¨ì „íˆ ì¡°íšŒí•˜ë ¤ë©´, 3ë²ˆ 4ë²ˆ 5ë²ˆ ì½”ë©˜íŠ¸ë¥¼ ê°ê° ì¡°íšŒí•´ì•¼í•©ë‹ˆë‹¤.(ë¬¼ë¡  in ì¿¼ë¦¬ë¡œ í•œë²ˆì— ì¡°íšŒí•  ìˆ˜ ìˆì§€ë§Œ, ë¹„ìœ ì ì¸ ìƒí™©ì´ë‹ˆê¹Œ ..)

ê²°ë¡ ì ìœ¼ë¡œ `1ë²ˆ ì½”ë©˜íŠ¸ ì°¾ì•„ë¼!`, `2ë²ˆ ì½”ë©˜íŠ¸ ì°¾ì•„ë¼!`, `3ë²ˆ ì½”ë©˜íŠ¸ë¥¼ ì°¾ì•„ë¼!` ì™€ ê°™ì€ ì–´ìƒ‰í•œ ìƒí™©ì´ ìƒê¸°ê²Œ ë©ë‹ˆë‹¤.

ê·¸ë˜ì„œ ì¼ë°˜ì ìœ¼ë¡œ ì—°ê´€ê´€ê³„ì˜ ì£¼ì¸, ì¦‰ ì™¸ë˜í‚¤ë¥¼ ìœ„ì™€ ê°™ì´ ì •í•˜ëŠ” ê²ƒ ì…ë‹ˆë‹¤.

## N + 1 ë¬¸ì œ

ê·¸ë ‡ë‹¤ë©´, ê¸°ë³¸ì ìœ¼ë¡œ ì—°ê´€ê´€ê³„ë¥¼ ì„¤ì •í•´ë‘ë©´ ì¡°íšŒê°€ ë‘ë²ˆ ë°œìƒí•œë‹¤ëŠ”ê²Œ ìì—°ìŠ¤ëŸ½ê²Œ ì´í•´ê°€ ë˜ì‹¤ê²ë‹ˆë‹¤.

"1ë²ˆ Postë¥¼ ì°¾ì•„ì¤˜!", "1ë²ˆ Postì˜ idë¥¼ ì™¸ë˜í‚¤ë¡œ ê°€ì§€ê³  ìˆëŠ” Commentë¥¼ ì°¾ì•„ì¤˜!" ì´ë ‡ê²Œ ë‘ë²ˆì˜ ì¿¼ë¦¬ê°€ ë°œìƒí•˜ê²Œ ë˜ëŠ”ë°ìš”.

ì—¬ê¸°ì„œ ë¬¸ì œëŠ” ì—¬ëŸ¬ê±´ì˜ Postë¥¼ ì¡°íšŒí•  ë•Œ ë°œìƒí•©ë‹ˆë‹¤.

"Post 5ê°œ ì°¾ì•„ì¤˜!"

"ì²« ë²ˆì§¸ Postì˜ idë¥¼ ì™¸ë˜í‚¤ë¡œ ê°€ì§€ê³  ìˆëŠ” Commentë¥¼ ì°¾ì•„ì¤˜!"

"ë‘ ë²ˆì§¸ Postì˜ idë¥¼ ì™¸ë˜í‚¤ë¡œ ê°€ì§€ê³  ìˆëŠ” Commentë¥¼ ì°¾ì•„ì¤˜!"

"ì„¸ ë²ˆì§¸ Postì˜ idë¥¼ ì™¸ë˜í‚¤ë¡œ ê°€ì§€ê³  ìˆëŠ” Commentë¥¼ ì°¾ì•„ì¤˜!"

"ë„¤ ë²ˆì§¸ Postì˜ idë¥¼ ì™¸ë˜í‚¤ë¡œ ê°€ì§€ê³  ìˆëŠ” Commentë¥¼ ì°¾ì•„ì¤˜!"

"ë‹¤ì„¯ ë²ˆì§¸ Postì˜ idë¥¼ ì™¸ë˜í‚¤ë¡œ ê°€ì§€ê³  ìˆëŠ” Commentë¥¼ ì°¾ì•„ì¤˜!"

ì´ë ‡ê²Œ ì´ (5 + 1) ë²ˆì˜ ì¿¼ë¦¬ê°€ ë°œìƒí•˜ê²Œ ë©ë‹ˆë‹¤.


```sql
SELECT c.id, c.content, c.post_id
FROM Comment c
WHERE c.post_id = 1;

SELECT c.id, c.content, c.post_id
FROM Comment c
WHERE c.post_id = 2;

...

SELECT c.id, c.content, c.post_id
FROM Comment c
WHERE c.post_id = 5;
```


## í•´ê²°ë°©ë²• 1. fetchType.LAZY

ì‚¬ì‹¤ ì´ëŸ¬í•œ ìƒí™©ì€ fetchTypeì˜ ê¸°ë³¸ê°’ì¸ EAGER ë•Œë¬¸ì— ë°œìƒí•©ë‹ˆë‹¤.

EAGERëŠ” ì¦‰ì‹œë¡œë”©ì´ë¼ëŠ” ëœ»ìœ¼ë¡œ, Postë¥¼ ì¡°íšŒí•  ë•Œ Commentë„ ê°™ì´ ì¡°íšŒí•˜ê² ë‹¤ëŠ” ì˜ë¯¸ì…ë‹ˆë‹¤. (ì •í™•í•˜ê²ŒëŠ” ì—°ê´€ëœ ì—”í‹°í‹°ë¥¼ ê°™ì´)

ë°˜ë©´ì— LAZYëŠ” ì§€ì—°ë¡œë”©ì´ë¼ëŠ” ëœ»ìœ¼ë¡œ, Postë¥¼ ì¡°íšŒí•  ë•Œ CommentëŠ” ì¡°íšŒí•˜ì§€ ì•Šê² ë‹¤ëŠ” ì˜ë¯¸ì…ë‹ˆë‹¤.

ì—¬ê¸°ì„œ í”„ë¡ì‹œ ê°ì²´ê°€ ì‚¬ìš©ë˜ëŠ”ë°ìš”, í”„ë¡ì‹œëŠ” "ìš°íšŒí•œë‹¤"ëŠ” ëœ»ìœ¼ë¡œ, ë””ë¹„ì—ì„œ ë°”ë¡œ ì¡°íšŒí•˜ëŠ” ëŒ€ì‹  í”„ë¡ì‹œ ê°ì²´ë¥¼ ë¨¼ì € ì¡°íšŒí•˜ê³ , ì‹¤ì œë¡œ ì‚¬ìš©í•  ë•Œ ë””ë¹„ì—ì„œ ì¡°íšŒí•˜ëŠ” ë°©ì‹ì…ë‹ˆë‹¤.

ì¡°ê¸ˆ ë” ì§ê´€ì ìœ¼ë¡œëŠ” "ê°€ì§œ ê°ì²´ë¥¼ ë§Œë“¤ì–´ë‘ê³ , ì‹¤ì œë¡œ ì‚¬ìš©í•  ë•Œ ë””ë¹„ì—ì„œ ì¡°íšŒí•œë‹¤" ë¼ê³  ìƒê°í•˜ì‹œë©´ ë©ë‹ˆë‹¤.

ì¡°ê¸ˆ ê³¼ê²©í•œ ë¹„ìœ ì´ì§€ë§Œ, ê°€ì§œ ì½”ë©˜íŠ¸ë“¤ì„ ë§Œë“¤ì–´ë‘ê³  í¬ìŠ¤íŠ¸ì— ì ì°ì–´ì„œ ì½”ë©˜íŠ¸ë¥¼ ì“¸ë•Œ ì‹¤ì œ ë””ë¹„ì—ì„œ ì¡°íšŒí•˜ëŠ” ë°©ì‹ì´ë¼ê³  ìƒê°í•˜ì‹œë©´ ë©ë‹ˆë‹¤.

ë¬¼ë¡  ì´ê±´ ê·¼ë³¸ì ì¸ í•´ê²°ì±…ì€ ì•„ë‹ˆì§€ë§Œ, ì •ë§ í•„ìš”í•  ê²½ìš°ì—ë§Œ ë””ë¹„ë¡œ ì¿¼ë¦¬ê°€ ë‚˜ê°€ë‹ˆ ì‹¤ì œë¡œëŠ” N + 1ë²ˆ ì¿¼ë¦¬ê°€ ë°œìƒí•˜ì§€ ì•ŠëŠ” ì •ë„ë¡œ í‰ì¹ ìˆ˜ ìˆëŠ” ìƒí™©ì´ ìˆìŠµë‹ˆë‹¤.

'ì˜ë„ì¹˜ ì•Šê²Œ' N+1ë¡œ ì¿¼ë¦¬ê°€ ë°œìƒí•˜ëŠ” 'ìƒí™©'ì´ ë¬¸ì œë¼ë©´, FetchType.LAZYë¡œ ì„¤ì •í•˜ëŠ” ê²ƒë„ í•˜ë‚˜ì˜ í•´ê²°ì±…ì´ ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

> ë¬¼ë¡  ê·¼ë³¸ì ì¸ ì´ì•¼ê¸°ë¥¼ í•˜ìë©´, ì‹¤ì œë¡œ 'ëª¨ë“  ì—°ê´€ëœ ì—”í‹°í‹°ì— ëŒ€í•œ ì°¸ì¡°ê°€ ì¼ì–´ë‚œë‹¤ë©´' FetchType.LAZYëŠ” ì ˆëŒ€ í•´ê²°ì±…ì´ ë  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. 
> ë‹¤ë§Œ, ì´ê±´ Big O í‘œê¸°ë²•ê³¼ ë§ˆì°¬ê°€ì§€ë¡œ, ìµœì•…ì˜ ê²½ìš°ë¥¼ ê°€ì •í–ˆì„ë•Œ N + 1 ë¬¸ì œê°€ ë°œìƒí•œë‹¤ëŠ” ê²ƒ ì…ë‹ˆë‹¤.
> ê·¸ë˜ì„œ ë§ì´ë“¤ í•˜ì‹œëŠ” ì‹¤ìˆ˜ê°€, í•´ë‹¹ ì—”í‹°í‹°ì˜ ì°¸ì¡°ê°€ ì¶©ë¶„íˆ ê°„í—ì ì´ê³  ìœ ë™ì ì¼ ìˆ˜ ìˆëŠ”ë° ëª¨ë‘ Fetch Joinì„ ì‚¬ìš©í•´ë²„ë¦¬ë©´ ì˜¤íˆë ¤ ë¦¬ì†ŒìŠ¤ì˜ ë‚­ë¹„ê°€ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
> ì´ëŸ¬í•œ ê²½ìš° ì‹¤ì œ ì—°ê´€ ì—”í‹°í‹°ì˜ ì°¸ì¡°ê°€ í•„ìš”í•œ ê²½ìš°ê°€, í•œ ë²ˆ ë” ì¿¼ë¦¬ê°€ í•„ìš”í•œ ì‹œì ì´ë¼ê³  ì¸ì§€í•œë‹¤ë©´ Fetch joinì„ ì‚¬ìš©í•˜ëŠ” ê²ƒ ë³´ë‹¤ í›¨ì”¬ íš¨ìœ¨ì ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.



## í•´ê²°ë°©ë²• 2. fetch join

ì‚¬ì‹¤ ì´ê²Œ ê·¼ë³¸ì ì¸ í•´ê²°ì±…ì¸ë°, ì—¬ê¸°ì„œë¶€í„°ëŠ” ì¡°ê¸ˆ ë” ì •í™•í•œ ì¿¼ë¦¬ë¥¼ ì‘ì„±í•´ì„œ í•´ê²°í•˜ëŠ” ë°©ë²•ì…ë‹ˆë‹¤.

```java
public interface PostRepository extends JpaRepository<Post, Long> {
    @Query("SELECT p FROM Post p JOIN FETCH p.comments WHERE p.id = :postId")
    Post findPostWithComments(@Param("postId") Long postId);
}
```

ì¿¼ë¦¬ë¥¼ ì•„ê¹Œì²˜ëŸ¼ í’€ë©´, (ë‹¤ì†Œ ì˜ì—­) "Postë¥¼ ì¡°íšŒí•˜ë©´ì„œ, Postí…Œì´ë¸”ê³¼  Commentì„ ë¶™ì—¬ì„œ ì½”ë©˜íŠ¸ë„ ê°™ì´ ì¡°íšŒí•´ì¤˜!" ë¼ê³  ìš”ì²­í•˜ëŠ” ì¿¼ë¦¬ì…ë‹ˆë‹¤.

## Post í…Œì´ë¸”

| id  | title         | content            |
|-----|---------------|--------------------|
| 1   | First Post    | This is the first post. |
| 2   | Second Post   | This is the second post. |
| 3   | Third Post    | This is the third post. |

## Comment í…Œì´ë¸”

| id  | content         | post_id |
|-----|-----------------|---------|
| 1   | First comment   | 1       |
| 2   | Second comment  | 1       |
| 3   | Third comment   | 2       |

## ì¡°ì¸ëœ ê²°ê³¼

| Post.id | Post.title  | Post.content           | Comment.id | Comment.content   |
|---------|-------------|------------------------|------------|-------------------|
| 1       | First Post  | This is the first post.| 1          | First comment     |
| 1       | First Post  | This is the first post.| 2          | Second comment    |
| 2       | Second Post | This is the second post.| 3         | Third comment     |

ì´ë ‡ê²Œ ì¿¼ë¦¬ë¥¼ ì‘ì„±í•˜ë©´, Postì™€ Commentë¥¼ ì¡°ì¸í•´ì„œ ì¡°íšŒí•˜ê²Œ ë˜ë¯€ë¡œ, N + 1 ë¬¸ì œê°€ ë°œìƒí•˜ì§€ ì•Šê³  ë‹¨ê±´ì˜ ì¿¼ë¦¬ë¡œ ì¡°íšŒê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.
