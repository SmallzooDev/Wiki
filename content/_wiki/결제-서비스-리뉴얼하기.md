---
title: ë ˆê±°ì‹œ ê²°ì œ ì„œë¹„ìŠ¤ ë¦¬ë‰´ì–¼, ëª¨ë“  pg ì„œë¹„ìŠ¤ ì—°ë™ ê°œë°œ íšŒê³  ğŸ’¸
summary: ì´ê±¸ ì „ë¶€ ë‚´ê°€ í–ˆë‹¤ê³ .. ìŠ¤ìŠ¤ë¡œ ë¿Œë“¯í•´ì„œ ì“°ëŠ” í›„ê¸°
date: 2025-01-21 17:15:43 +0900
lastmod: 2025-02-21 18:31:56 +0900
tags:
  - Postings
  - blog
categories: 
description: 
showToc: true
tocOpen: true
---

## Intro â³
---
### ë°°ê²½
í”„ë¡ íŠ¸ì—”ë“œ í”„ë¡œì íŠ¸ì˜ ì „ë©´ ë¦¬ë‰´ì–¼ë¡œ ê¸°ì¡´ viewë¥¼ ì§ì ‘ ë°˜í™˜í•˜ëŠ” mvc ì„œë¹„ìŠ¤ì—ì„œ ê²°ì œ ê´€ë ¨ ì„œë¹„ìŠ¤ë“¤ì„ rest-apiì „í™˜í•˜ê³  ëª¨ë“  ê²°ì œ ëª¨ë“ˆë“¤ì„ ë‹¤ì‹œ ì—°ë™í•´ì•¼í•˜ëŠ” ì´ìŠˆë¥¼ ë°°ì •ë°›ì•˜ë‹¤.

### AS-IS
ê¸°ì¡´ì—ë„ í”„ë¡ íŠ¸ì—”ë“œ í”„ë¡œì íŠ¸ëŠ” ë”°ë¡œ next.jsë¡œ ë”°ë¡œ ì„œë¹„ìŠ¤ë˜ê³  ìˆì—ˆì§€ë§Œ ì „ì‹œì˜ì—­ì„ ì œì™¸í•œ ë¡œê·¸ì¸/ë§ˆì´í˜ì´ì§€ì™€ ê°™ì€ ì¸ì¦ê´€ë ¨ëœ í˜ì´ì§€ë“¤, ê²°ì œ/ì£¼ë¬¸ ê´€ë ¨ëœ í˜ì´ì§€ë“¤ì€ ê¸°ì¡´ ë©”ì¸ ë°±ì—”ë“œ ì„œë²„ê°€ ë·°ê¹Œì§€ ë°˜í™˜í•˜ê³  ìˆì—ˆëŠ”ë°, ì´ë²ˆ ì „ë©´ ë¦¬ë‰´ì–¼ì„ í†µí•´ í•´ë‹¹ í˜ì´ì§€ë“¤ë„ ì‹ ê·œ í”„ë¡œì íŠ¸ë¡œ ì „í™˜ ì‘ì—…ì´ í•„ìš”í–ˆë‹¤.


### ë¬¸ì œì 
ì€ ë‹¹ì—°íˆ ì‹œê°„ì´ì—ˆë‹¤â³. 

ì£¼ë¬¸/ê²°ì œìª½ì´ ê°€ì¥ ê¸°íšì´ ëŠ¦ê²Œ ë‚˜ì˜¨ ë„ë©”ì¸ì´ê¸°ë„ í–ˆê³ , ì¼ë¶€ íŒŒì•…í•  ì‹œê°„ì„ ë¯¸ë¦¬ ê°€ì§€ê¸´ í–ˆì§€ë§Œ íƒœìŠ¤í¬ì— ë°°ì •ë°›ì€ ì‹œê°„ì´ 1ë‹¬ ì•½ê°„ ë„˜ëŠ” ë¹ ë“¯í•œ ì‹œê°„ìœ¼ë¡œ ì ì—ˆê³ , í”„ë¡ íŠ¸ì—”ë“œ ë°±ì—”ë“œ ì‘ì—…ì„ ëª¨ë‘ í˜¼ì ì§„í–‰í•´ì•¼ í–ˆì—ˆë‹¤.

ë‹¹ì¥ ì—°ë™í•´ì•¼í•˜ëŠ” pgì‚¬ê°€ ë„¤,ì¹´,í†  í˜ì´ + ê¸°ì¡´ ì¹´ë“œê²°ì œ ê³„ì¢Œì´ì²´ ê²°ì œ + ì‚¬ì´íŠ¸ ì „ìš© ê²°ì œì™€ ê°™ì´ ë§¤ìš° ë‹¤ì–‘í•œ(...) ëª¨ë“ˆì„ ì—°ë™í•´ì•¼ í–ˆë‹¤.

ë¬¼ë¡  ì¼ì •ì´ ë§ˆì¼ìŠ¤í†¤ìœ¼ë¡œ ì¡íŒê±´ ì•„ë‹ˆê³ , ê°ì•ˆí•´ì„œ ë²„í¼ë¥¼ ì£¼ì‹œê¸´ í•˜ì…¨ì§€ë§Œ ì „ì²´ì ìœ¼ë¡œ ì˜¤í”ˆ/QAì¼ì •ì´ ì´‰ë°•í•´ì„œ ì¼ì •ì••ë°•ì´ ê±°ì…Œë‹¤.


## í•´ì•¼í•˜ëŠ” ì¼ íŒŒì•…í•˜ê¸° ğŸ¤”
---
ê¸°ì¡´ì— ì§„í–‰í–ˆë˜ í”„ë¡œì íŠ¸ì—ì„œë„ ê²°ì œë¥¼ ìƒˆë¡œ êµ¬í˜„í•œ ì ì´ ìˆì—ˆê³ , ë‹¹ì‹œì— ê²°ì œ ëª¨ë“ˆì„ ë³´ê³  ê³µë¶€í•˜ë©´ì„œ ìƒê¸´ ë…¸í•˜ìš°ì™€ ê·¸ ë•Œ ë´ì™”ë˜ ì½”ë“œë“¤ì´ ìˆì–´ì„œ ì¼ë‹¨ ì—…ë¬´ë¥¼ ê²€í† í•˜ê¸°ëŠ” ë¶€ë¶„ì€ ì¡°ê¸ˆ ìˆ˜ì›”í•˜ê²Œ ì§„í–‰ë˜ì—ˆë‹¤.


### ê²°ì œê³¼ì •ì˜ ì¶”ìƒí™”
> ê²°ì œë‹¨ê³„ëŠ” í¬ê²Œ ë‘ê°€ì§€ë¡œ ì¶”ìƒí™” í•  ìˆ˜ ìˆë‹¤.
![ê²°ì œ](https://github.com/user-attachments/assets/37f838d5-5ab5-4a42-9b62-e198e6879338)
ì¶œì²˜ : https://docs.tosspayments.com/guides/v2/get-started/payment-flow

**ê²°ì œ ì¸ì¦ ë‹¨ê³„**
- ìš”ì²­í•œ í´ë¼ì´ì–¸íŠ¸ê°€ pgì‚¬ë¥¼ í†µí•´ ë³¸ì¸ê³¼ ìš”ì²­ ê·¸ë¦¬ê³  ì§€ë¶ˆ ëŠ¥ë ¥ì´ ìˆëŠ”ì§€ë¥¼ ê²€ì¦í•˜ëŠ” ê²°ì œ ì¸ì¦ë‹¨ê³„
**ê²°ì œ ìŠ¹ì¸ ë‹¨ê³„**
- ìš”ì²­ì˜ ê²°ê³¼ì™€ ê° ì„œë²„ì˜ ê²°ì œ ë¡œì§ì„ ê¸°ë°˜ìœ¼ë¡œ ì‹¤ì œ ê²°ì œë¥¼ ì§„í–‰í•˜ëŠ” ê²°ì œ ìŠ¹ì¸ë‹¨ê³„.

ì‚¬ì‹¤ ì´ë²ˆ ê¸°íšŒì— ë‹¤ë¥¸ ëª¨ë“ˆë“¤ë„ ê²€í† í•´ë´¤ì„ ë•Œ ìš”ì¦˜ ì‚¬ìš©í•˜ëŠ” ëŒ€ë¶€ë¶„ pgì‚¬ë“¤ì€ ìœ„ì˜ ë‘ê°€ì§€ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë‹¨ê³„ë¥¼ ë‚˜ëˆ„ê³  ìˆëŠ” ê²ƒ ê°™ë‹¤. 

ì•½ê°„ì˜ ì°¨ì´ì ì´ ìˆì–´ë´ì•¼ ê²°ì œ 'ì¸ì¦' ê³¼ì •ì— ì¡°ê¸ˆ ì°¨ì´ê°€ ìˆê±°ë‚˜ í•œ ì •ë„ì¸ ê²ƒ ê°™ë‹¤.

ì˜ˆë¥¼ ë“¤ì–´ ì¸ì¦ ì „ì— ë¯¸ë¦¬ 'ê²°ì œ ì¸ì¦'ì„ ìœ„í•œ ì‹ë³„ê°’ì„ ì¡°ê¸ˆ ë” ëŒ€ì¡°í•œë‹¤ë˜ì§€, í´ë¼ì´ì–¸íŠ¸ì˜ ê²°ì œ ìš”ì²­ì´ ê°ˆ ê²ƒ ì´ë¼ê³  ë¯¸ë¦¬ ì•Œë ¤ì•¼ í•œë‹¤ë˜ì§€ í•˜ëŠ” ì •ë„.

ì´ì™€ ê°™ì€ ê´€ì ì„ ê¸°ì¤€ìœ¼ë¡œ í•˜ë©´ êµ¬í˜„í•´ì•¼ í•  ë¶€ë¶„ì„ ì¡°ê¸ˆ ë” ë‹¨ìˆœí•˜ê²Œ êµ¬ë¶„ í•  ìˆ˜ ìˆë‹¤.

```
1. ê²°ì œ ìš”ì²­ì„ ìœ„í•œ ì¤€ë¹„ë¥¼ í•œë‹¤.
2. í´ë¼ì´ì–¸íŠ¸ê°€ ì‹¤ì œë¡œ ê²°ì œ ìš”ì²­ì„ í•˜ë©´ pgì‚¬ë¡œ ì´ë™
3. ê²°ì œ 'ì¸ì¦'ì˜ ê²°ê³¼ë¥¼ ì½œë°±ë°›ëŠ”ë‹¤.
4. ê²°ì œ ì¸ì¦ ê²°ê³¼ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë‚´ë¶€ë¡œì§ì„ ì²˜ë¦¬í•˜ê³  'ìŠ¹ì¸' ìš”ì²­ apië¥¼ ë‚ ë¦°ë‹¤.
5. ê²°ì œ 'ìŠ¹ì¸'ê²°ê³¼ë¥¼ ë¶„ê¸°ë¡œ ê²°ì œë¥¼ ì™„ë£Œì²˜ë¦¬í•œë‹¤.
```

ì´ë ‡ê²Œ ë‹¨ê³„ë¥¼ ë‚˜ëˆ„ê³  ê¸°ì¡´ ì—°ë™ ì½”ë“œì™€ ì—°ë™ ë¬¸ì„œë¥¼ ê²€í† í–ˆì„ ë•Œ, í•´ë‹¹ íë¦„ì„ ë²—ì–´ë‚˜ëŠ” pgì‚¬ëŠ” ë‹¤í–‰íˆ ì—†ì—ˆë‹¤.


### ê²°ì œ ìš”ì²­ì„ ìœ„í•œ ì¤€ë¹„ë¥¼ í•˜ëŠ” ë¶€ë¶„, pgì‚¬ ì´ë™
í¬ê²ŒëŠ” ì²´í¬ì•„ì›ƒì„ ìœ„í•œ ì„œë²„ ë‚´ë¶€ ë¡œì§,

(íŠ¹ì • pgì‚¬ ë§Œ) ê²°ì œë¥¼ ìœ„í•œ ì˜ˆì•½(?) í•¸ë“œì‰ì´í¬(?) ì‘ì—…,

(pgì‚¬ì— ë”°ë¼ì„œ) í´ë¼ì´ì–¸íŠ¸ í‚¤ì™€ ê°™ì€ ì‹ë³„ê°’ì„ í´ë¼ì´ì–¸íŠ¸ì— ë‚´ë ¤ì£¼ê¸°,

(í´ë¼ì´ì–¸íŠ¸) ê²°ì œ ëª¨ë“ˆ sdk inití•˜ê¸°

ë¡œ ë‚˜ëˆ„ì–´ ë³¼ ìˆ˜ ìˆë‹¤.

AS-ISì—ì„œëŠ” 

checkoutViewFile ë°˜í™˜
```java
public String checkout() {
	doSomeServerCheckoutLogic(); //ê²°ì œ ì˜ˆì•½ì„ ìœ„í•œ ì„œë²„ ë¡œì§
	setSomeDataToSession();
	return checkoutPage;
}
```

checkoutPage.hbs
```html
<html lang="ko">
<head>
Â  Â  <!-- ê²°ì œ ê´€ë ¨ PG ìŠ¤í¬ë¦½íŠ¸ -->
Â  Â  <script src="https://pg1.example.com/sdk.js"></script>
Â  Â  <script src="https://pg2.example.com/sdk.js"></script>
</head>
<body>
Â  Â  <button id="payButton">ê²°ì œí•˜ê¸°</button>
Â  Â  <script>
Â  Â  Â  Â  document.getElementById("payButton").addEventListener("click", handleClickPay);
Â  Â  Â  Â  function handleClickPay() {
Â  Â  Â  Â  Â  Â  // ê²°ì œ ì¤€ë¹„ ìš”ì²­ì„ ì„œë²„ì— ë³´ëƒ„
Â  Â  Â  Â  Â  Â  let someData = callPrepareCheckout();
Â  Â  Â  Â  Â  Â  // ê²°ì œ ëª¨ë“ˆ SDK í˜¸ì¶œ (someDataë¥¼ ì´ìš©)
Â  Â  Â  Â  Â  Â  if (someData.pgType === "KAKAO_PAY") {
Â  Â  Â  Â  Â  Â  Â  Â  callKakaoPaySdk(someData);
Â  Â  Â  Â  Â  Â  } else if (someData.pgType === "PG2") {
Â  Â  Â  Â  Â  Â  Â  Â  callPg2Sdk(someData);
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("ì§€ì›í•˜ì§€ ì•ŠëŠ” PG íƒ€ì…ì…ë‹ˆë‹¤.");
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  function callPrepareCheckout() {
Â  Â  Â  Â  Â  Â  return {
Â  Â  Â  Â  Â  Â  Â  Â  pgType: "KAKAO_PAY", // PGì‚¬ íƒ€ì…
Â  Â  Â  Â  Â  Â  Â  Â  paymentInfo: {} // ê¸°íƒ€ í•„ìš”í•œ ë°ì´í„°
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  }

Â  Â  Â  Â  function callKakaoPaySdk(data) {
Â  Â  Â  Â  Â  Â  console.log("ì¹´ì¹´ì˜¤í˜ì´ SDK í˜¸ì¶œ", data);
Â  Â  Â  Â  Â  Â  // ì‹¤ì œ ì¹´ì¹´ì˜¤í˜ì´ SDK í˜¸ì¶œ ë¡œì§
Â  Â  Â  Â  }

Â  Â  Â  Â  function callPg2Sdk(data) {
Â  Â  Â  Â  Â  Â  console.log("PG2 SDK í˜¸ì¶œ", data);
Â  Â  Â  Â  Â  Â  // ì‹¤ì œ PG2 SDK í˜¸ì¶œ ë¡œì§
Â  Â  Â  Â  }
Â  Â  </script>
</body>
</html>
```

ê²°ì œ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´
```java
@GetMapping("/prepare")
public ResponseEntity<?> prepareCheckout(PgType pgType) {
	...
Â  Â  switch (pgType) {
Â  Â  Â  Â  case KAKAO_PAY:
Â  Â  Â  Â  Â  Â  doingSomeJobs(); // PGì‚¬ë³„ë¡œ ë³„ë„ì˜ ì‘ì—… ìˆ˜í–‰
Â  Â  Â  Â  Â  Â  saveSomeDataAtSession(); // ê²°ì œ ìš”ì²­ ê´€ë ¨ ë°ì´í„°ë¥¼ ì„¸ì…˜ì— ì €ì¥
Â  Â  Â  Â  Â  Â  break;
Â  Â  }
	...
Â  Â  return someDataForCallingPaymentModule(); // ê²°ì œ ëª¨ë“ˆ í˜¸ì¶œì„ ìœ„í•œ ì¶”ê°€ ë°ì´í„° ë°˜í™˜

}
```

ì´ëŸ°ì‹ìœ¼ë¡œ ë˜ì–´ìˆì—ˆë‹¤.

### ê²°ì œë¥¼ ìŠ¹ì¸í•˜ëŠ” ë¶€ë¶„
> "ê·¸ë•Œ ê·¸ë ‡ê²Œ í•œ ê²ƒì€ ê·¸ë•Œì˜ ì´ìœ ê°€ ìˆë‹¤!"

ë³´í†µ ê²°ì œëŠ” ì¸ì¦ì˜ ì²˜ë¦¬í•œ ê²°ê³¼ë¥¼ ë¯¸ë¦¬ pgì‚¬ì™€ ì•½ì†ì„ í•´ë†“ëŠ”ë‹¤. ìµœì‹  sdkí˜¹ì€ ëª¨ë“ˆë“¤ì€ sdkë¥¼ í˜¸ì¶œí•˜ëŠ” ì‹œì ì— callbackë°›ì„ endpointë¥¼ ë„˜ê¸°ê³ , ê·¸ë ‡ì§€ ì•Šì€ ëª¨ë“ˆë“¤ì€ ë¯¸ë¦¬ ì•Œë ¤ì£¼ê±°ë‚˜ ë“±ë¡í•´ì•¼ í•˜ëŠ” ì •ë„ê°€ ë‹¤ë¥´ë‹¤.

ê·¸ë˜ì„œ approvalê³¼ ê°™ì€ í•˜ë‚˜ì˜ ì—”ë“œí¬ì¸íŠ¸ë¡œ ê·¸ê±¸ ì²˜ë¦¬í•œë‹¤.

AS-ISì—ì„œëŠ” 

```java
class ApprovalHandler {
	private PgService kakaoPayService;
	private PgService pg1Service;
	// ë‹¤ë¥¸ pgì‚¬ ì„œë¹„ìŠ¤ë“¤ 
	...

	public Boolean approval(HttpServletRequest req);
}
```

```java
@GetMapping("/approval")
public String approval(HttpServletRequest req, PgType pgType) {
	switch (pgType)
	// ì´í›„ ì§ì‘ê°€ëŠ¥í•œëŒ€ë¡œ
}
```

> ëˆˆì—¬ê²¨ ë³¼ì ì€ ìŠ¹ì¸ê³¼ ê´€ë ¨í•œ ë°ì´í„°ë¥¼ dtoë¡œ ë¯¸ë¦¬ ë°›ì•„ë†“ì§€ ì•Šê³ , ê·¸ëƒ¥ reqê°ì²´ì—ì„œ pgì‚¬ ì„œë¹„ìŠ¤ë“¤ì´ ì•Œì•„ì„œ ë½‘ì•„ì“°ë„ë¡ í•´ë’€ë‹¤ëŠ” ê²ƒì´ë‹¤.

ë¬¼ë¡  ë³€ê²½ì— ìœ ì—°í•˜ê±°ë‚˜ ì¢‹ê³  ì˜ˆìœ ì½”ë“œëŠ” ì•„ë‹ˆì§€ë§Œ, ê·¸ë˜ë„ ë¦¬í€˜ìŠ¤íŠ¸ë¥¼ ì§ì ‘ ë„˜ê¸°ëŠ” ì‹ìœ¼ë¡œ êµ¬í˜„ë˜ì—ˆê¸° ë•Œë¬¸ì— ê° ê²°ì œëŒ€í–‰ì‚¬ì˜ í”„ë¡œí† ì½œëŒ€ë¡œ ì§ì ‘ êµ¬í˜„í•´ì•¼í•˜ëŠ” ë¶€ë¶„ì˜ ì½”ë“œê°€ í™• ì¤„ì—ˆë‹¤.

ì´ ì‹œì ì—ì„œ ì •í•´ì§„ ê¸°ê°„ ë‚´ë¡œ êµ¬í˜„í•  ìˆ˜ ìˆê² ë‹¤ëŠ” ìƒê°ì´ ë˜ì—ˆë‹¤.

ì¦‰ ìŠ¹ì¸ ì´í›„ì˜ ì‹œì ì€ ìš°ë¦¬ í”„ë¡ íŠ¸ì—”ë“œ ì„œë²„ê°€ ì¸ì¦ ì½œë°±ìœ¼ë¡œ ë°›ì€ ìš”ì²­ì„ ë°±ì—”ë“œ ì„œë²„ë¡œ ë™ì¼í•˜ê²Œ í¬ì›Œë“œ í•´ì¤„ìˆ˜ ìˆìœ¼ë©´ ë‚´ê°€ ì‹ ê²½ì„ ì“¸ í•„ìš”ê°€ ì—†ì—ˆë‹¤.


## ì§„ì§œ í•´ì•¼í•  ì¼ ì •ë¦¬ âœ…
---
1. ì²´í¬ì•„ì›ƒ ì¤€ë¹„, ì£¼ë¬¸ì„œ ë·° ë°˜í™˜í•˜ëŠ” apiì—ì„œ ì²´í¬ì•„ì›ƒ ì¤€ë¹„í•˜ëŠ” ë¶€ë¶„ì„ ë³„ë„ì˜ ìš”ì²­ìœ¼ë¡œ ë¶„ë¦¬í•˜ê³  ë·°ë¥¼ ê·¸ë¦´ë•Œ í•„ìš”í•œ ì •ë³´ ì •ë¦¬í•´ì„œ apiì¶”ê°€í•˜ê¸° (ë³´ì•ˆìƒì˜ ì´ìœ ë¡œ ì„œë²„ì»´í¬ë„ŒíŠ¸ë¡œ ì²˜ë¦¬í•˜ê¸°ìœ„í•´ì„œ next.jsì™€ ë°±ì—”ë“œ ì„œë²„ê°€ ì§ì ‘ í†µì‹ í•˜ë„ë¡ êµ¬í˜„)
2. next.jsì—ì„œ 'ì¸ì¦ ê²°ê³¼' ì½œë°± ë°›ì„ ìˆ˜ ìˆë„ë¡ ì—”ë“œí¬ì¸íŠ¸ ì¶”ê°€í•˜ê¸°
3. ì½œë°±ë°›ì€ 'ì¸ì¦ ê²°ê³¼' í¬ì›Œë“œí•˜ì—¬ ìš°ë¦¬ ë°±ì—”ë“œ ì„œë²„ì˜ ìŠ¹ì¸ ë¡œì§ í˜¸ì¶œ
4. ì´ê±¸ ìœ„í•œ ìˆ˜ë§ì€ í”„ë¡ íŠ¸ì—”ë“œ ì½”ë“œ ì¶”ê°€ (...)



## Impl & TroubleShootings ğŸš€
---
> ë°±ì—”ë“œ ë¶€ë¶„ì€ ì•„ë¬´ë¦¬ ì˜ˆì‹œì½”ë“œë¡œ ì£¼ìš” ë¡œì§ì„ ìˆ˜ë„ì½”ë“œë¡œ ì‘ì„±í•´ë„ ì˜ˆë¯¼í•œ ë¶€ë¶„ì¼ ìˆ˜ ìˆì–´ ë¡œì§ì ì¸ ë¶€ë¶„ì„ ì´ì•¼ê¸°í•˜ê¸°ê°€ ì–´ë µë‹¤.

> ìœ„ì— ì‘ì„±í•œ 1ë²ˆì˜ ë‚´ìš©ì—ì„œ í¬ê²Œ ë²—ì–´ë‚˜ì§€ ì•ŠëŠ” ì‘ì—…ë“¤ê³¼ ì„¸ë¶€ì‚¬í•­ ì²˜ë¦¬, ì—”ë“œí¬ì¸íŠ¸ë“¤ì„ ìƒˆë¡œìš´ ì¸í„°í˜ì´ìŠ¤ë§ê²Œ ì •ë¦¬í•˜ê³  ëª‡ê°€ì§€ ë¦¬íŒ©í† ë§í•œê²Œ ì „ë¶€ì´ë‹¤.

> ë°˜ë©´ í´ë¼ì´ì–¸íŠ¸ìª½ì€ ì˜ˆì‹œì½”ë“œê°€ ê°€ì¥ ì˜ ê³µê°œë˜ì–´ìˆëŠ” í† ìŠ¤ ëª¨ë“ˆì„ ê¸°ì¤€ìœ¼ë¡œ í•˜ê³  ì˜ˆë¯¼í•œ ë¶€ë¶„ë“¤ì„ ì œê±°í•˜ê³  í¬ìŠ¤íŒ…í–ˆë‹¤.

ì´í›„ë¶€í„°ëŠ” ì¼ë‹¨ ê²°ì œë¥¼ ì¤€ë¹„í•˜ê¸° ìœ„í•œ ì£¼ë¬¸ì„œ ë¡œì§ì„ ì²˜ë¦¬í•œ ì´í›„ì˜ êµ¬í˜„ì´ë‹¤.
ê¸°ë³¸ êµ¬ì¡°ë¥¼ ì•„ë˜ì™€ ê°™ì´ ì •ë¦¬í–ˆë‹¤.
```
(ì£¼ë¬¸ì„œ ì§„ì… ìš”ì²­ ì´ì „ì— ì„œë²„ì—ëŠ” ì£¼ë¬¸ì„œ ë°ì´í„°ì˜ ê²°ì œ ê´€ë ¨ ì¤€ë¹„ê°€ ë˜ì–´ìˆìŒ)
1. ê²°ì œ ë²„íŠ¼ í´ë¦­
	ë°ìŠ¤í¬íƒ‘ì´ë©´ -> ìƒˆë¡œìš´ window open (ê²°ì œ ëª¨ë“ˆ í˜ì´ì§€)
	ëª¨ë°”ì¼ì´ë©´ -> ê²°ì œ ëª¨ë“ˆ í˜ì´ì§€ë¡œ ì´ë™

2. ê²°ì œ ëª¨ë“ˆ í˜ì´ì§€ì—ì„œ ê²°ì œ ì¤€ë¹„ apií˜¸ì¶œ, ê²°ì œ ëª¨ë“ˆ ì¤€ë¹„

3. ì¸ì¦ ì´í›„ ì½œë°±ì„ route.tsë¡œ ë°›ì€ ì´í›„ requestë°ì´í„°ì™€ í•¨ê»˜ callbackí˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸

4. callback í˜ì´ì§€ì—ì„œ ìŠ¹ì¸ api í˜¸ì¶œ

ê²°ì œ ì™„ë£Œ!
```
### TroubleShooting : ê²°ì œì°½ ì—´ê¸°
ê²°ì œì°½ì„ ë°íƒ‘ì—ì„œëŠ” ë³„ë„ì˜ ìœˆë„ìš°ë¡œ ì²˜ë¦¬í•˜ê³  ìˆì—ˆë‹¤.

ê·¸ë¦¬ê³  í•´ë‹¹ ìœˆë„ìš°ì—ì„œ ìŠ¤í¬ë¦½íŠ¸ë¥¼ í˜¸ì¶œí•˜ë©´ ê²°ì œì‚¬ ì‚¬ì´íŠ¸ë¡œ ì´ë™í•˜ëŠ” êµ¬ì¡°ì˜€ê³ ,

í•´ë‹¹ ì°½ì—ì„œ ì„±ê³µ/ì‹¤íŒ¨í•œê²½ìš° `opener` ê°ì²´ì— ìˆëŠ” ì£¼ë ì£¼ë  í•¨ìˆ˜ë¡œ ì½œë°±ì„ ì²˜ë¦¬í•˜ê¸°ë„ í–ˆë‹¤.

ë‹¹ì‹œì— openerë¥¼ ì§ì ‘ ì°¸ì¡°í•˜ëŠ”ê²ƒê³¼ ìœˆë„ìš°ê°ì²´ì— ê¼­ í•„ìš”í•œ ê²ƒë“¤ë§Œ ì •ì˜í•´ì„œ ì‚¬ìš©í•˜ìëŠ” í”„ë¡ íŠ¸ë¶„ë“¤ì˜ ë£°ì´ ìˆì—ˆë‹¤.

ê·¸ë˜ì„œ ì°½ê°„ì˜ í†µì‹ ì„ `postMessage`ë¥¼ ì´ìš©í•´ì„œ ì²˜ë¦¬í•˜ë„ë¡ ìˆ˜ì •í–ˆë‹¤.

ê¼­ í•„ìš”í•œ ì½œë°±ì˜ ê²½ìš° ëª…ì‹œì ìœ¼ë¡œ postMessageë¡œ ë¶€ëª¨ì°½ì— ë©”ì„¸ì§€ë¥¼ ì „ë‹¬í•˜ê³  í•´ë‹¹ ë©”ì„¸ì§€ë¥¼ ì²˜ë¦¬í•˜ëŠ” í•¸ë“¤ëŸ¬ë¥¼ ë‘ì—ˆë‹¤.

```typescript
const usePaymentPopup = () => {  
  useEffect(() => {  
    const handleMessage = (event: MessageEvent) => {  
      if (event.origin === window.location.origin && event.data === 'someId') {  
        clearPaymentInterval();  
        setIsWindowOpen(false);  
        payWindowRef.current = null;  
      }    };  
    if (isWindowOpen) {  
	  // handleMessageë¡œ ìƒˆë¡œ ì—´ë¦° ê²°ì œí˜ì´ì§€ì—ì„œ ë³´ë‚¸ ì½œë°±ì„ ë°›ì•„ ì²˜ë¦¬í•œë‹¤
      window.addEventListener('message', handleMessage);  
      intervalRef.current = setInterval(() => {  
        if (payWindowRef?.current?.closed) {  
          if (!payWindowRef.current) return;  
  
          clearPaymentInterval();  
          Alert('ê²°ì œê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤').then(() => {  
            setIsWindowOpen(false);  
            payWindowRef.current = null;  
          });
        }      
    }, 100);  
    }  

    return () => {  
      clearPaymentInterval();  
      window.removeEventListener('message', handleMessage);  
    };  }, [isWindowOpen, clearPaymentInterval]);  
  
  return { openPaymentPopup };  
};
```


### Impl : ê²°ì œí˜ì´ì§€ êµ¬í˜„í•˜ê¸°
> í”„ë¡ íŠ¸ì—”ë“œ ì»´í¬ë„ŒíŠ¸ë¥¼ ê°œí¸í•œ ë°±ì—”ë“œ api ë‹¨ê³„ì— ë§ê²Œ ì¶”ìƒí™”í•´ì„œ êµ¬í˜„

**PaymentPage ì˜ˆì‹œ**
```typescript
export default function TossPaymentPage() {  
  const { data: response, isFetching, isSuccess, isError } = useQueryPaymentPrepare<TossPreparePaymentData>('TOSS');  
  
  usePaymentPreparation<PreparePaymentResponse<TossPreparePaymentData>>({  
    isFetching,  
    isError,  
    isSuccess,  
    response,  
  });  
  if (isSuccess && response.data) {  
    return <>{isSuccess && response && <TossPaymentHandler preparePaymentData={response.data} />}</>;  
  }  
  return <div />;  
}
```
"ì„œë²„ì˜ pgì‚¬ë³„ ê²°ì œ ë°ì´í„° ì¤€ë¹„, ì„¸íŒ…",

"ê²°ì œ ëª¨ë“ˆì„ í˜¸ì¶œí•˜ê¸° ìœ„í•œ ì •ë³´ ì¡°íšŒ api",

"í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œì˜ ê²°ì œ ëª¨ë“ˆ ì¤€ë¹„"

ì™€ ê°™ì€ ë‹¨ê³„ë¡œ ë‚˜ëˆ„ì–´ ì»´í¬ë„ŒíŠ¸ë¥¼ ì‘ì„±í–ˆë‹¤.

`useQueryPaymentPrepare` ì—ì„œ useQueryë¥¼ ì´ìš©í•´ì„œ pgì‚¬ë³„ ë°±ì—”ë“œ ê²°ì œ ì¤€ë¹„ apië¥¼ í˜¸ì¶œí•œë‹¤.


**ë°±ì—”ë“œ ê²°ì œ ì¤€ë¹„ apií˜¸ì¶œë¶€**
```typescript
// ì œë„¤ë¦­ì€ pgì‚¬ë¥¼ ì˜ë¯¸!
interface UsePaymentPreparationHandlerProps<T> {  
  isFetching: boolean;  
  isError: boolean;  
  isSuccess: boolean;  
  response: { data: T } | undefined;  
}  
  
export default function usePaymentPreparation<T>({  
  isFetching,  
  isError,  
  isSuccess,  
  response,  
}: UsePaymentPreparationHandlerProps<T>) {  
  useOverlayLoadingContext(Boolean(isFetching));  
  
  useEffect(() => {  
    if (!isFetching) {  
      if (isError) {  
        alert('ê²°ì œ ì¤€ë¹„ ì„±ê³µ!');  
        if (opener) {  
          self.close();  
        } else {  
          gotToCheckoutPage();  
        }        return;  
      }  
      if (isSuccess && !response) {  
        alert('ê²°ì œ ì¤€ë¹„ ì‹¤íŒ¨!');  
        if (opener) {  
          self.close();  
        } else {  
          gotToCheckoutPage();  
        }        return;  
      }    }  
  }, [isSuccess, isError, isFetching, response]);  
}
```
> ì°¸ê³ ë¡œ ì¤€ë¹„ì™€, sdk í˜¸ì¶œì„ ìœ„í•œ ë°ì´í„°ë¥¼ ë°›ì•„ì˜¤ëŠ” api ë¶„ë¦¬í•œ ì´ìœ ëŠ” ë‹¤ë¥¸ pgì‚¬ë¥¼ ê³ ë ¤í–ˆì„ë•Œ, ì´ë ‡ê²Œ ë‹¨ê³„ë¥¼ ë‚˜ëˆ„ëŠ”ê²Œ ìœ ë¦¬í–ˆê³  ì„œë²„ìª½ì—ì„œ ì‘ì—…í•˜ê¸° ì´ë ‡ê²Œ ë‹¨ê³„ë¥¼ ë‚˜ëˆ„ëŠ”ê²Œ í¸ë¦¬í–ˆê¸° ë•Œë¬¸ì´ì—ˆë‹¤.


**ê²°ì œëª¨ë“ˆ ì¤€ë¹„**
```typescript
export default function TossPaymentHandler({ preparePaymentData: data }: TossPaymentHandlerProps) {  
  const isProcessingRequestRef = useRef(false);  
  const [scriptLoaded, setScriptLoaded] = useState(false);  
  
  useEffect(() => {  
    if (scriptLoaded && window.TossPayments && !isProcessingRequestRef.current) {  
      isProcessingRequestRef.current = true;  
      const tossPrepareData = data.preparePaymentData;  
      const clientKey = tossPrepareData.clientKey;  
      const payParams = {  
        ...tossPrepareData?.payParams,  
      };      const tossPayments = window.TossPayments(clientKey);  
      tossPayments  
        .requestPayment('í† ìŠ¤ê²°ì œ', {  
          amount: payParams.amount,  
          orderId: payParams.orderId,  
          orderName: payParams.goodsName,  
          customerName: payParams.buyerName,  
          successUrl: `${payParams.returnUrl}?pgType=TOSS`,  
          failUrl: payParams.cancelUrl,  
        })        .catch(function (error: unknown) {  
          const newError = error as { code: string };  
          if (newError.code === 'USER_CANCEL') {  
            if (opener) {  
              alert('ê²°ì œë¥¼ ì·¨ì†Œí•˜ì…¨ìŠµë‹ˆë‹¤.');  
              self.close();  
            }          }        });    }  
	}, [data, scriptLoaded]);  
  
  return (  
    <Script  
      src="https://js.tosspayments.com/v1"  
      strategy="afterInteractive"  
      onLoad={() => setScriptLoaded(true)}  
      onError={() => {  
        console.error('í† ìŠ¤ê°€ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì•ˆì¤¬ì–´ìš” ã… ã… ');  
      }}    />  
  );  
}
```

ì—¬ê¸°ê¹Œì§€ êµ¬í˜„í–ˆì„ë•Œ, ë‚´ê°€ ì„¤ê³„í•˜ê³  ê°œí¸í•œ ë°±ì—”ë“œ ì¸í„°í˜ì´ìŠ¤ì™€ í”„ë¡ íŠ¸ì—”ë“œ ì»´í¬ë„ŒíŠ¸ ë‹¨ê³„ë¥¼ ë‚˜ëˆ„ì–´ ì„¤ê³„í•œê²Œ ëª¨ë“  pgì‚¬ì— ì ìš© ê°€ëŠ¥í•œ êµ¬ì¡°ë¼ì„œ ë„ˆë¬´ í–‰ë³µí–ˆì—ˆë‹¤.

ê·¸ë¦¬ê³  ì—¬ê¸°ê¹Œì§€ê°€ ê²°ì œ "ì¸ì¦"ì˜ ëì ì´ë‹¤.

### Impl : ìŠ¹ì¸ ê´€ë ¨ í´ë¼ì´ì–¸íŠ¸ì—ì„œ í•´ì£¼ëŠ” ì¼ë“¤!
ì¼ë‹¨ ì½œë°±ì„ í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ë°›ì•„ì•¼ í•˜ê¸°ì— ì—”ë“œí¬ì¸íŠ¸ë¥¼ next.jsì˜ route.tsë¥¼ ì´ìš©í•´ì„œ ëš«ì—ˆë‹¤.

ê·¸ë¦¬ê³  ìƒê¸°í•œ ì´ìœ ë¡œ ì½œë°±ë°›ì€ ìš”ì²­ì„ ê·¸ëŒ€ë¡œ ë°±ì—”ë“œ ì„œë²„ë¡œ í¬ì›Œë“œ í•´ì¤˜ì•¼ í•˜ê¸° ë•Œë¬¸ì—, 

ìš”ì²­ì„ í¬ì›Œë“œí•˜ê¸°ìœ„í•œ util.ts í•¨ìˆ˜ë¥¼ ë§Œë“¤ì–´ êµ¬í˜„í–ˆë‹¤.

ì½œë°± ì£¼ì†Œê°€ ì—¬ëŸ¬ê°œì¸ ì´ìœ ëŠ” ê²°ì œë¼ì¸(?)ì´ ë‹¤ë¥´ê³  ê°ê° ë‹¤ë¥¸ ì¸í„°í˜ì´ìŠ¤ë¥¼ í˜¸ì¶œí•´ì•¼í•˜ëŠ”ë° ê·¸ê±¸ ì‹ë³„í•´ì•¼ í•˜ê¸° ë•Œë¬¸ì— ê¸°ì¡´ ì—”ë“œí¬ì¸íŠ¸ë“¤ì´ ë¶„ê¸°ë˜ì–´ ìˆì—ˆê¸° ë•Œë¬¸ì´ë‹¤.

(ì˜ˆë¥¼ë“¤ì–´ ë°°ì†¡ë¹„, êµí™˜ê´€ë ¨, ìˆ˜ì„ ê´€ë ¨, ì‹¤ì œ ì£¼ë¬¸ ê²°ì œ ë“±ë“±)

ë¬´íŠ¼ pgì‚¬ë¡œë¶€í„° ì¸ì¦ê²°ê³¼ ì½œë°±ì„ ì „ë‹¬ë°›ìœ¼ë©´ ì´ apië¡œ ë°›ì•„ì„œ next.jsí˜ì´ì§€ë¡œ ì§ì ‘ ë¦¬ë‹¤ì´ë ‰íŠ¸ í•´ì£¼ëŠ”ì‹ìœ¼ë¡œ ì²˜ë¦¬ëœë‹¤.

```
apps
â””â”€â”€ ëª¨ë…¸ë ˆí¬web
Â  Â  â”œâ”€â”€ app
Â  Â  â”‚ Â  â”œâ”€â”€ (api)
Â  Â  â”‚ Â  â”‚ Â  â”œâ”€â”€ Pay
Â  Â  â”‚ Â  â”‚ Â  â”‚ Â  â”œâ”€â”€ authorizeCallback 
Â  Â  â”‚ Â  â”‚ Â  â”‚ Â  â”‚ Â  â””â”€â”€ route.ts # ìš”ëŸ°ë°ë¡œ pgì‚¬ ì½œë°± apië¥¼ ë°›ì•„ì„œ next.js í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸!
Â  Â  â”‚ Â  â”‚ Â  â”‚ Â  â”œâ”€â”€ authorizeCallback2
Â  Â  â”‚ Â  â”‚ Â  â”‚ Â  â”‚ Â  â””â”€â”€ route.ts
Â  Â  â”‚ Â  â”‚ Â  â”‚ Â  â”œâ”€â”€ authorizeCallback3
Â  Â  â”‚ Â  â”‚ Â  â”‚ Â  â”œâ”€â”€ util.ts
Â  Â  â”‚ Â  â”œâ”€â”€ proxy
Â  Â  â”‚ Â  â”œâ”€â”€ layout.tsx
```


**ë¦¬ë‹¤ì´ë ‰íŠ¸ í˜ì´ì§€ì—ì„œ í˜¸ì¶œí•˜ëŠ” ì½œë°± í•¨ìˆ˜**
```typescript
export default function useAfterPaymentCallback(params: { callbackType: PaymentCallbackType }) {  
  const isProcessingRequestRef = useRef(false);  
  const payParams = usePayParams();  
  const callbackType = params?.callbackType ?? '';  

  // í´ë¼ì´ì–¸íŠ¸ê°€ ìš”ì²­ì„ ìŠ¹ì¸ apië¡œ í¬ì›Œë“œí• ë•Œ pgì‚¬ ì½œë°±ê³¼ ë™ì¼í•˜ê²Œ ë§Œë“¤ì–´ì£¼ê³  ëª‡ëª‡ ë³´ì•ˆê´€ë ¨ ì´ìŠˆë¥¼ í•´ê²°í•˜ëŠ” ìœ í‹¸í•¨ìˆ˜
  const params = useMemo(() => {  
	forwardParams(payParams);
  }, [searchParams]);  

  // ì‹¤ì œ ì„œë²„ ìŠ¹ì¸ api í˜¸ì¶œ
  const { mutate: mutateFinishCallback } = useMutationPaymentFinishPayment({  
    // ìŠ¹ì¸ api í˜¸ì¶œ ê²°ê³¼ì— ë”°ë¼ ì²˜ë¦¬ë¡œì§ì€ ê·¸ëƒ¥ ë”°ë¡œ.
    onSuccess: (result) => handleSuccess(callbackType, result),  
    onError: (error) => handleError(callbackType, error),  
  });  
  useEffect(() => {  
    if (!isProcessingRequestRef.current) {  
      isProcessingRequestRef.current = true;  
  
      if (!callbackType) {  
        alert('ê²°ì œ ê³¼ì • ì¤‘ ë¬¸ì œê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤.');  
        return;  
      }  
      mutateFinishCallback({ callbackType, params });  
    }  }, [callbackType, queryParams]);  
  
  useOverlayLoadingContext();  
}
```


ë“œë””ì–´ ê¸¸ê³  ê¸´ ê³¼ì •ì´ ëë‚¬ë‹¤!


## ê²°ë¡  ğŸ’ª
---
1. ê²°ì œ ì„œë¹„ìŠ¤ë¥¼ í˜¼ìì„œ ë°±ì—”ë“œ í”„ë¡ íŠ¸ì—”ë“œ ì „ë¶€ ë¦¬ë‰´ì–¼í–ˆë‹¤.
2. ì˜ë„í•œëŒ€ë¡œ, ì‘ì—…ì´ ì§„í–‰ë˜ì—ˆê³  ê·¸ ê²°ê³¼ê°€ ì²˜ìŒ ì˜ë„ì™€ ë”± ë§ì•„ ë–¨ì–´ì§€ëŠ”ê²Œ ì¾Œê°ì´ ì¢‹ì•˜ë‹¤.
