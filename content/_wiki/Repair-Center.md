---
title: 분산환경에서 결제 구현하기 💭
summary: 
date: 2025-05-28 00:51:19 +0900
lastmod: 2025-05-28 10:55:40 +0900
tags: 
categories: 
description: 
showToc: true
tocOpen: true
---

## As-Is
---
![pg](https://github.com/user-attachments/assets/80460bf6-6f77-4671-bba9-953ef11e42a3)

### 일반적인 그리고 기존 결제 흐름
1. 클라이언트가 결제를 요청
2. 서버가 결제를 진행하는데 필요한 정보를 응답
3. 해당 내용을 토대로 pg사 호출
4. pg사의 사용자 인증 이후 콜백
5. 콜백받은 정보를 상태로 저장하고 있던 정보와 대조하고, 문제없으면 pg사로 승인 api 호출
6. pg사의 승인 응답 
7. 승인 여부를 db에 저장 (결제 승인 응답, 로그, 대사작업에 필요한 정보 등)
8. 회계처리를 진행하는 서버에 저장



## To-Be
---
### 새로운 요구사항들 (배경)
1. 회사 그룹의 오프라인 매장에서 판매된 상품까지 수선 서비스의 대상이 됨에 따라서 다른 계열사와의 협업이 필요하게 되었다. 
2. 온오프라인 자사 상품을 관리하는 별도의 서버와 통신하며 구현해야 했다.
3. 의사결정된 내용은 비즈니스 로직과 기존 로직들은 기존처럼 처리하고 처리한 결과를 forward해서 on/offline 서비스에 저장, 그 외에 회계처리만 저쪽 서버에서 진행하기로 했다.

> 비즈니스 로직을 처리하고 포워드, 해당 서버로부터 전달 받은 데이터를 통해 비즈니스 로직을 처리하는건 별로 어려운 일은 아니었다. 기본적으로 동시성 이슈가 발생 할 일이 거의 없는 사용자 관련 데이터를 위주로 여러 데이터 소스에서 불러온 데이터를 기반으로 간단하게 검증하는 로직이 전부였다. 문제는 결제쪽이었는데..😕 
### 새로운 요구사항들 (결제 관련)
1. 기존과 동일한 결제 로직을 따라야 한다. 즉 주문 관련 데이터가 외부에 있지만, 회계처리 반영하는 것을 제외하고는 기존처럼 처리되어야 한다.
2. 외부 서버 또한 만만치 않은 레거시 서버이기도 하고, 여러가지 사정상 큐 또는 메세징 시스템을 이용해서 요청을 직렬화 할 수 없다.
3. 그 와중에 여러 결제 수단을 지원하고 싶으면서도 작업 공수를 줄이기(?) 위해 pg사의 신모듈을 붙여야 했다.

결과적으로 아래와 같은 흐름으로 작업을 정리했다.

간단한 컴포넌트 추가인데 복잡도가 상당히 증가했고 구현해야하는 인터페이스, 신경써야 할 것들이 너무 많았다.

![pg2](https://github.com/user-attachments/assets/8484b194-9883-4173-b657-2ae2bad46514)


## TroubleShootings
---

## Impl
---
>todo : 상태 추가를 한 이야기, 로컬 캐시를 쓰지 못한 이유, 트랜잭션으로 묶여야 했던 것들, 


## 회고
---
> todo : 아쉬웠던점, 아웃박스를 두려고 했다면, 나중에 알게된 사실 (socket timeout)

